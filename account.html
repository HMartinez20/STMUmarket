---
title: Account Page
---
<!DOCTYPE html>
<html>
  <head>
    {% include header.html %}
    {% include fire.html %}
	  
  </head>
	<body>
		{% include navBar.html %}
		
		<div id="fileSubmit">
		</div>
		
		<!-- BODY WITH THE USERNAME AND EDIT PROFILE BUTTON -->
		<!-- <div class="container-fluid"> -->
		<div style="margin-left:45px; margin-right:45px;" >
			<div class="row ml-5 mr-5">
				<div class="col-xl-3 bg-light">
				 	<button type="button" class="mt-5 mx-auto d-block bg-transparent text-dark btn btn-primary" data-toggle="collapse" data-target="#ProfileDesc">About Myself</button>
					  <div id="ProfileDesc" class="mt-3 ml-3 collapse"></div>
				</div>
			
			<div class="col-xl-9">
				<h2 class = "ml-5" id="showUser"></h2>
				<h4 class = "ml-5" id="showName"></h4>
				
				<!-- EDIT PROFILE BUTTON -->
					<!-- Button to Open the Edit Profile -->
					<button type="button" class="ml-5 mb-5 btn btn-primary" data-toggle="modal" data-target="#myModal">Edit Profile</button>

						<!-- The Modal -->
						<div class="modal fade" id="myModal">
							<div class="modal-dialog">
								<div class="modal-content">

									<!-- Modal Header -->
									<div class="modal-header">
										<h4 class="modal-title">Edit your Information below</h4>
										<button type="button" class="close" data-dismiss="modal">&times;</button>
									</div>

									<!-- Modal body -->
									<div class="modal-body">
										<form>
											<div class="form-row">
												<div class="form-group col-md-6">
													<label for="inputFirstName">First Name</label>
													<input type="text" class="form-control" id="inputFirstName" placeholder="First Name">
												</div>
												<div class="form-group col-md-6">
													<label for="inputLastName">Last Name</label>
													<input type="text" class="form-control" id="inputLastName" placeholder="Last Name">
												</div>
											</div>
											<div class="form-group">
												<label for="inputUserName">User Name</label>
												<input type="text" class="form-control" id="inputUserName" placeholder="User Name">
											</div>
											<div class="form-group">
													<label for="inputContactNumber">Contact Number</label>
													<input type="text" class="form-control" id="inputContactNumber" placeholder="Your Contact Number">
												</div>

											<div class="form-group">
												<label for="inputBio">Bio</label>
												<input type="text" class="form-control" id="inputBio" placeholder="About yourself">
											</div>
											<button type="submit" class="btn btn-primary" onclick="updateAccount();">Submit</button>
								</form>
									</div>

									<!-- Modal footer -->
									<div class="modal-footer">
										<button type="button" class="btn btn-danger" data-dismiss="modal">Cancel</button>
									</div>

								</div>
							</div>
						</div><!-- EDIT PROFILE BUTTON ENDS -->
				
				
			<!-- MY INFORMATION TABLE -->
			<div class="container-fluid bg-light">
			 <div class="row ml-5 mr-5">
					<table class="mt-5 mx-auto d-block table-sm. table">
					    <thead> </thead>
					    <tbody>
					      <tr>
						<td><p class="font-weight-bold">Email:</p></td>
						<td><p id="showEmail"></p></td>
					      </tr>
					      <tr>
						<td><p class="font-weight-bold">Contact Number:</p></td>
						<td><p class=""> Cell Phone</p></td>
					      </tr>
					    </tbody>
					 </table>		
			 </div>
		</div>
				 
				
				
				
			  </div> 
			</div> 
		</div>

		<!-- MENU BAR -->
		<!-- <div class="container-fluid"> -->
		<div style="margin-left:45px; margin-right:45px;" >
				<div class="row ml-5 mr-5 mt-4 mb-4"> 

					<div class = "col-xl">
						<div class="card">
							<ul class="nav nav-pills nav-justified">
								<li class="nav-item"><a class="nav-link" data-toggle="tab" href="#menu1">My Active Listings</a></li>
								<li class="nav-item"><a class="nav-link" data-toggle="tab" href="#menu2">My Sold Listings</a></li>
								<li class="nav-item"><a class="nav-link" data-toggle="tab" href="#menu3">My Purchases</a></li>
							</ul>

							<div class="tab-content">
								<div id="menu1" class="mt-3 ml-3 mr-3 mb-3 tab-pane fade">
									<h3>Active Listings</h3>
									<div id="myActiveListings"> </div>
								</div>
								<div id="menu2" class="mt-3 ml-3 mr-3 mb-3 tab-pane fade">
									<h3>Sold Listings</h3>
									<div id="mySoldListings"> </div>
								</div>
								<div id="menu3" class="mt-3 ml-3 mr-3 mb-3 tab-pane fade">
									<h3>My Purchases</h3>
									<div id="myPurchases"></div>
								</div>
							</div>

						</div>
					<!-- end of card nav -->
					</div> 
			</div>
		</div>
		
		<!-- BELOW THE ITEM NAV BAR -->	
		
		
<!-- Create new posting button -->
<div class="modal fade" id="modalContactForm" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">Create New Posting</h4>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">

	<!-- Radio -->
        <p class="text-left">
          <strong>Item Type:</strong>
        </p>
	      
        <div class="form-check mb-4">
          <input class="form-check-input" name="group1" type="radio" id="radio-179" value="books" checked>
          <label class="form-check-label" for="radio-179">Books</label>
        </div>

        <div class="form-check mb-4">
          <input class="form-check-input" name="group1" type="radio" id="radio-279" value="clothing">
          <label class="form-check-label" for="radio-279">Clothing</label>
        </div>
				
        <div class="form-check mb-4">
          <input class="form-check-input" name="group1" type="radio" id="radio-379" value="electronics">
          <label class="form-check-label" for="radio-379">Electronics</label>
        </div>

        <div class="form-check mb-4">
          <input class="form-check-input" name="group1" type="radio" id="radio-479" value="furniture">
          <label class="form-check-label" for="radio-479">Furniture</label>
        </div>
        <div class="form-check mb-4">
          <input class="form-check-input" name="group1" type="radio" id="radio-579" value="other">
          <label class="form-check-label" for="radio-579">Other</label>
        </div>
        <!-- Radio -->

        <div class="md-form mb-5">
          <i class="fas fa-user prefix grey-text"></i>
          <input type="text" id="form34" class="form-control validate">
          <label data-error="wrong" data-success="right" for="form34">Item Name</label>
        </div>

        <div class="md-form mb-5">
          <i class="fas fa-envelope prefix grey-text"></i>
          <input type="text" id="form29" class="form-control validate">
          <label data-error="wrong" data-success="right" for="form29">Price</label>
        </div>


        <div class="md-form mb-5">
          <i class="fas fa-pencil prefix grey-text"></i>
          <textarea type="text" id="form8" class="md-textarea form-control" rows="4"></textarea>
          <label data-error="wrong" data-success="right" for="form8">Item Description</label>
        </div>	
	<!-- Upload button for multiple images -->
	      
	 <div class="md-form">
                <!-- IMPORTANT:  FORM's enctype must be "multipart/form-data" -->
                <form method="post" action="upload-page.php" enctype="multipart/form-data">
                <input name="filesToUpload[]" id="filesToUpload" type="file" multiple />
                </form>
          </div>
      </div>
      <div class="modal-footer d-flex justify-content-center">
        <button class="btn btn-unique" onclick="writeNewItem();">Create Posting<i class="fas fa-paper-plane-o ml-1"></i></button>
      </div>
    </div>
  </div>
</div>

<div class="text-center">
  <a href="" class="btn btn-default btn-rounded mb-4" data-toggle="modal" data-target="#modalContactForm">Create New Posting</a>
</div>
<br><br><br>
<!--....THIS IS THE END OF CODE FOR THE CREATE NEW POSTING BUTTON...-->

	</body>
	{% include footer.html %}
</html>
<script>
	const storage = firebase.storage(); // Reference to storage service
	var currentUser;
	var username; // for file handling
	
	/* authentication state observer */
	firebase.auth().onAuthStateChanged(function(user){
	 	if(user){
			console.log("signed in:",user.uid);
			console.log("signed in:",user);
			currentUser = user.uid;
			username = (user.email).substring(0, (user.email).indexOf('@'));
			/* get user's data */
			db.collection("users").doc(user.uid).get().then(function(doc) {
				if (doc.exists){
					window.data = doc.data();
					/* append username and name */
					document.getElementById("showUser").append(data.username);
					document.getElementById("showName").append(data.first + " " + data.last);
					document.getElementById("showEmail").append(data.email);
					document.getElementById("ProfileDesc").append(data.bio);
					
					/* Show user's active listings */
					db.collection('items').where('seller', '==', data.username).where('sold', '==', "no").get().then((snapshot) => {
						console.log("getting active listings");
						var postCount = snapshot.size;
						var postNum = 0;
						var listings = document.createElement("div"); /* container for listings */
						var dRow; /* row of listings */
						/* add a listing card for each listing */
						snapshot.docs.forEach(doc => {
							if (postNum % 3==0){ /* start new row */
								dRow = document.createElement("div");
								dRow.className = "row";	
							}
							postNum+=1;
						
							/* get image url */
							var imgSrc = "{{site.baseurl}}/Empty.jpg";
							if(doc.data().image1){ imgSrc = doc.data().image1; }
							/* create col for listing */
							var col = document.createElement("div");
							col.setAttribute("class","col-4");
							/* create card for listing */
							var card = document.createElement("div");
							card.setAttribute("class","card");
							card.innerHTML= '<img src="'+imgSrc+'" class="card-img-top"/>'; 
							card.innerHTML += '<div class="card-body"><a class="card-title" href="' + ('item.html#' + doc.id) + '" target="_blank">'+ doc.data().title +'</a><p class="card-text">$'+ doc.data().price;
							card.innerHTML += '</p></div>';
							
							col.appendChild(card);
							dRow.appendChild(col);
							
							if (postNum % 3==0 || postNum==postCount){ listings.appendChild(dRow); }
						})
						document.getElementById("myActiveListings").appendChild(listings);
					})
					/* end of listing code */	
					
					/* code for sold listings */
					/* code for purchased listings */
					db.collection('items').where('seller', '==', data.username).where('sold', '==', "yes").get().then((snapshot) => {
						console.log("getting sold listings");
						var postCount = snapshot.size;
						var postNum = 0;
						var listings = document.createElement("div"); /* container for listings */
						var dRow; /* row of listings */
						/* add a listing card for each listing */
						snapshot.docs.forEach(doc => {
							if (postNum % 3==0){ /* start new row */
								dRow = document.createElement("div");
								dRow.className = "row";	
							}
							postNum+=1;
						
							/* get image url */
							var imgSrc = "{{site.baseurl}}/Empty.jpg";
							if(doc.data().image1){ imgSrc = doc.data().image1; }
							/* create col for listing */
							var col = document.createElement("div");
							col.setAttribute("class","col-4");
							/* create card for listing */
							var card = document.createElement("div");
							card.setAttribute("class","card");
							card.innerHTML= '<img src="'+imgSrc+'" class="card-img-top"/>'; 
							card.innerHTML += '<div class="card-body"><a class="card-title" href="' + ('item.html#' + doc.id) + '" target="_blank">'+ doc.data().title +'</a><p class="card-text">$'+ doc.data().price;
							card.innerHTML += '</p></div>';
							
							col.appendChild(card);
							dRow.appendChild(col);
							
							if (postNum % 3==0 || postNum==postCount){ listings.appendChild(dRow); }
						})
						document.getElementById("mySoldListings").appendChild(listings);
					})
					/* end purchased listing */
					/* end of sold listings */
					
					/* code for purchased listings */
					db.collection('items').where('soldTo', '==', data.username).get().then((snapshot) => {
						console.log("getting purchased listings");
						var postCount = snapshot.size;
						var postNum = 0;
						var listings = document.createElement("div"); /* container for listings */
						var dRow; /* row of listings */
						/* add a listing card for each listing */
						snapshot.docs.forEach(doc => {
							if (postNum % 3==0){ /* start new row */
								dRow = document.createElement("div");
								dRow.className = "row";	
							}
							postNum+=1;
						
							/* get image url */
							var imgSrc = "{{site.baseurl}}/Empty.jpg";
							if(doc.data().image1){ imgSrc = doc.data().image1; }
							/* create col for listing */
							var col = document.createElement("div");
							col.setAttribute("class","col-4");
							/* create card for listing */
							var card = document.createElement("div");
							card.setAttribute("class","card");
							card.innerHTML= '<img src="'+imgSrc+'" class="card-img-top"/>'; 
							card.innerHTML += '<div class="card-body"><a class="card-title" href="' + ('item.html#' + doc.id) + '" target="_blank">'+ doc.data().title +'</a><p class="card-text">$'+ doc.data().price;
							card.innerHTML += '</p></div>';
							
							col.appendChild(card);
							dRow.appendChild(col);
							
							if (postNum % 3==0 || postNum==postCount){ listings.appendChild(dRow); }
						})
						document.getElementById("myPurchases").appendChild(listings);
					})
					/* end purchased listing */
				}
				else {
					console.log("Requested document does not exist...");
				}
			}).catch(function(error) {
				console.log("Error getting document:", error);
			});
			
		}
		else{
			window.location = "https://hmartinez20.github.io/STMUmarket/login.html";
		}
	});
	
	var d = new Date();
    var dateFormatted = d.getDate().toString().padStart(2, '0')+(d.getMonth()+1).toString().padStart(2, '0')+d.getFullYear().toString();
	
	/* console.log(window.data.username); */
	function writeNewItem(){
		var selected = null;
		var radios = document.getElementsByName("group1");
		for(var i = 0; i < radios.length; i++){
			if (radios[i].checked){
				selected = radios[i].value;
				break;
			}
		}		
		db.collection("items").add({
			category: selected,
			title: document.getElementById("form34").value,
			price: Number(document.getElementById("form29").value),
			description: document.getElementById("form8").value,
			date: new Date(),
			seller: username,
			sellerId: firebase.auth().currentUser.uid,
			sold: "no",
			soldTo: ""
			// image1: window.imagePaths[0]
		})
		.then(function(docRef){
			console.log("ID = ", docRef.id);
			handleFileSelect(docRef.id);
		})
		.catch(function(error){
			alert("\n Error! Ask your administrator");
			console.log("Error writing document ", error);
		});
	}
	
	/* update account info */
					function updateAccount(){
						console.log(firebase.auth().currentUser.uid);
						return db.collection("users").doc(firebase.auth().currentUser.uid).update({
							first: document.getElementById("inputFirstName").value,
							last: document.getElementById("inputLastName").value,
							username: document.getElementById("inputUserName").value,
							bio: document.getElementById("inputBio").value,
							
							
							/* enter update fields here*/
						})
						.then(function() {
							console.log("Updated Account Info");
						})
						.catch(function(error) {
							console.log("Error updating document: ", error);
						});
					}
	
	function handleFileSelect(id){		
		var metaData = {
			customMetadata:{
				'item': id
			}
		};
		// Get file(s)
		var fileList = document.getElementById("filesToUpload");
		
		// Upload file(s) to storage
		if(fileList.files.length != 0){
			//window.imagePaths =[];
			var img;
			// Upload individual images
			for(var i = 0; i < fileList.files.length; i++){
				img = "image"+(i+1);
				var fileName = fileList.files[i].name;
				
				// Upload Image
				uploadImg(fileList.files[i], metaData, id, fileName, img);
				
				 // Create storage ref to where image will be stored
				 //const storageRef = storage.ref('posts/'+username+'/'+dateFormatted+'_'+fileName);
				 //window.imagePaths[i] = ('posts/'+currentUser+'/'+dateFormatted+'_'+fileName);

				 //task = storageRef.put(fileList.files[i], metaData);

				 //Upload progress
// 			 	task.on('state_changed',
// 					function progress(snapshot){},
// 					function error(err){ alert(err); },
// 					function complete(){ alert(fileName+"\nUploaded!"); }
// 				 );
			}
			alert("Posted!");
		 }
// 		else{
// 			window.imagePaths = ["", "", "", ""];
// 			console.log("else");	
// 		} /* end of else */
		
// 		db.collection("items").doc(id).set({
// 			image1: window.imagePaths[0],
// 			image2: window.imagePaths[1],
// 			image3: window.imagePaths[2],
// 			image4: window.imagePaths[3]
// 		}, { merge: true });
	}
	
	function uploadImg(file, metaData, id, fileName, img){
		var storageRef = storage.ref('posts/'+username+'/'+id+'/'+ fileName);  // Reference to WHERE the image will be stored
		var task = storageRef.put(file, metaData);
		
		// Upload Progress
		task.on('state_changed', 
			function(snapshot){},
			function(error){},
			function(){
				alert(fileName+"\nUploaded!");
				task.snapshot.ref.getDownloadURL().then(function(downloadURL){
					//console.log(downloadURL);
					var data = {};
					data[img] = downloadURL;
					var docRef = db.collection("items").doc(id);
					var mergeInfo = docRef.set( data, {merge:true} );
				});
			}
		);
	}

	
	
</script>
<script>
	function getInfo(){
		console.log("function called!!!");
	}
</script>

